# Домашнее задание №4. Кеширование.

## Метод добавления и удаления друга

Добавлен метод добавления друга: http://localhost:8080/api/v1/friend/set/{user_id}
Добавлен метод удаления друга: http://localhost:8080/api/v1/friend/delete/{user_id}

## CRUD для постов пользователей

Создана новая таблица для постов пользователей.
![posts table](<OTUS HW.png>)

Сделаны 4 метода для CRUD для постов пользователей.


## Лента постов друзей

## Инвалидация 

TTL (time to live) - не подходит, к постам сложно применить время жизни.
Инвалидация по событию - более подходящее под определение. В нашем случае - это создание нового поста (вопросы удаления или изменения поста пока не рассматриваются в рамках учебного задания).
Кэшируем всю ленту пользователя, но не более 100 постов.

Стратегия вытеснения
Исползуем TTL (Time to live). Предполагаем, что в нашем случае мы сортируем ленту от друзей по времени, тогда вытесняем из кеша самый "старый" пост.

Т.е. обновление кеша происходит одновременно с обновлением базы.




TODO: при обращении пользователя, если кеш не существует, то надо его создавать.

## Выбор способа кеширования
Уровни кеширования:
- браузерное;
- proxy;
- кэширование на уровне веб-сервера;
- кэширование на уровне БД

Заведем один кэш-сервер 

## Последовательность работы с кешем
Действие - кто-то добавил пост.
В кэше храним информацию о постах, которые необходимо отображать пользователю. (что с добавлением или удалением друзей?)

Используем возможность Postgres возвращать данные из измененных строк.
Когда вставляется новый пост, то мы обновляем список отображемых постов для всех друзей пользователя, которые вставил новый пост.
Для этого по id автора находим всех его друзей и по этому событию обновляем ленту у всех друзей этого пользователя.

Цель - сократить количество запросов к базе.
Т.е. сначала мы должны посмотреть в кеш, потом должны уже сомтреть 

!! Недостаток - изначальное не предполагалась сортировка постов по времени и в базу сгенерированы записи без времени. ToDo: добавить время создания поста и сортировку. "Протухать" должны старые посты.

## До кеширования время получения ленты постов
![alt text](image.png)
данному пользователю выдано 940 постов

